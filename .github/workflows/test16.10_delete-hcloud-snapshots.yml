name: "Delete old hetzner snapshots"

on:
  workflow_dispatch:

env:
  # Anzahl von Snapshots, die aufbewahrt werden sollen
  keep_snapshots: '1'
  
jobs:
  Delete:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ['ubuntu-20.04', 'ubuntu-22.04', 'ubuntu-24.04']

    steps:
      - name: "Check if variable 'keep_snapshots' exist"
        #if: ${{ env.keep_snapshots == '' }}
        #if: "!contains(env.keep_snapshots, '1')"
        if: "${{ vars.keep_snapshots == '' }}"
        run: |
          echo "Variable nicht gefunden. Job wird abgebrochen."
          exit 1
          
      - name: Install Hetzner Cloud Cli
        uses: hetznercloud/setup-hcloud@641015849308e9ed3e3b1f3d3b0a637068c5a2af # v1.0.1
        
      - name: Query und delete snapshots
        id: hlcoud_snapshot
        run: |
          # List all snapshots
          echo -e "$(hcloud image list --type "snapshot" -l "os=${{ matrix.image }}" -s "id:desc")\n"
          #hcloud image list --type "snapshot" -l "os=ubuntu-24.04" -s "id:desc"

          # Query
          objects=$(hcloud image list --output "columns=ID" --output "noheader" --type "snapshot" -l "os=${{ matrix.image }}" -s "id:desc" | tail -n +$(($keep_snapshots+1)) )
          
          if [ -n "$objects" ]; then
            echo "$(echo $objects | wc -w) Snapshot(s) zum Löschen gefunden:"

            for i in $objects ; do
              echo ID: "$i"
              #result=$(hcloud image delete $i --quiet 2>&1)
              result=$(hcloud image delete $i --quiet)
              
              echo "Snapshot wurde erfolgreich gelöscht."             
            done

          else
            echo "Keine Snapshots zum Löschen gefunden."
          fi
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
