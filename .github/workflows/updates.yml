name: Mediathekview Updates
on:
  workflow_dispatch:
    inputs:
      ReleaseName:
        description: 'Release Name'
        required: false
        #default: "Ubuntu 24.04 (20250302) Image Update"
        
      ReleaseTag:
        description: 'Release Tag'
        required: false
        #default: "ubuntu24/20250302.1"

jobs:
  BasicInformations:
    runs-on: ubuntu-latest

    steps:
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y%m%d')"
        
    outputs:
      ReleaseName: Ubuntu 24.04 (${{ steps.date.outputs.date }}) Image Update
      ReleaseTag: ubuntu24/${{ steps.date.outputs.date }}.1


  CreateTest:
    needs: BasicInformations
    runs-on: ubuntu-latest

    steps:
      - name: Write ReleaseName
        run: echo "${{ needs.BasicInformations.outputs.ReleaseName }}"

      - name: Write ReleaseTag
        run: echo "${{ needs.BasicInformations.outputs.ReleaseTag }}"

      - name: Create a new branch
        uses: peterjgrainger/action-create-branch@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          branch: ${{ needs.BasicInformations.outputs.ReleaseTag }}


  CreateVmTemplate:
    needs:
      - BasicInformations
      - CreateTest
    runs-on: ubuntu-latest

    steps:
      - name: Checkout new created branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.BasicInformations.outputs.ReleaseTag }}


      - name: Setup `packer`
        uses: hashicorp/setup-packer@main
        id: setup
        with:
          version: latest

      - name: Run `packer init`
        id: init
        run: "packer init ./images/ubuntu/templates/ubuntu-24.04.pkr.hcl"

      - name: Run `packer validate`
        id: validate
        run: "packer validate ./images/ubuntu/templates/ubuntu-24.04.pkr.hcl"
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

      - name: Run `packer build`
        id: build
        run: "packer build ./images/ubuntu/templates/ubuntu-24.04.pkr.hcl"
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
          

      - name: Commit & Push changes
        uses: actions-js/push@master
        with:
          branch: ${{ needs.BasicInformations.outputs.ReleaseTag }}
          github_token: ${{ secrets.GH_TOKEN }}
        
      - name: Create a new release
        uses: ncipollo/release-action@v1.14.0
        with:
          tag: ${{ needs.BasicInformations.outputs.ReleaseTag }}
          name: ${{ needs.BasicInformations.outputs.ReleaseName }}
          body: ${{ steps.ghpages.outputs.content }}
          token: ${{ secrets.GH_TOKEN }}

