name: Trigger Build workflow (Ubuntu)

on:
  workflow_call:
    inputs:
      release_name:
        required: true
        type: string
      release_tag:
        required: true
        type: string
      hcl_filename:
        required: true
        type: string


jobs:
  CreateNewBranch:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      #pull-requests: write


    steps:
      - name: Create a new branch
        uses: peterjgrainger/action-create-branch@10c7d268152480ae859347db45dc69086cef1d9c # v3.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          branch: ${{ inputs.release_tag }}

          
  CreateVmTemplate:
    needs: CreateNewBranch
    runs-on: ubuntu-latest

    permissions:
      contents: write
      #pull-requests: write


    steps:
#      - name: Create a new branch
#        uses: peterjgrainger/action-create-branch@v2.2.0
#        env:
#          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
#        with:
#          branch: ${{ inputs.release_tag }}

          
      - name: Checkout new created branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          #ref: ${{ needs.BasicInformations.outputs.ReleaseTag }}
          ref: ${{ inputs.release_tag }}


      - name: character-replacement-test
        id: hcloudvmname
        uses: mad9000/actions-find-and-replace-string@bce4d50390d08b67e1822bd72fb54b3cf11b0ce9 # 5
        with:
            source: ${{ inputs.release_tag }} # this translates to ref/heads/main on the main branch, but can be any arbitrary string 
            find: '/'        # we want to remove ref/heads/ from source 
            replace: '-'


      - name: Setup `packer`
        uses: hashicorp/setup-packer@1aa358be5cf73883762b302a3a03abd66e75b232 # v3.1.0
        id: setup
        with:
          version: latest

      - name: Run `packer init`
        id: init
        run: packer init ./images/ubuntu/templates/${{ inputs.hcl_filename }}

      - name: Run `packer validate`
        id: validate
        run: packer validate ./images/ubuntu/templates/${{ inputs.hcl_filename }}
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
          HCLOUD_SNAPSHOT_NAME: ${{ steps.hcloudvmname.outputs.value }}

      - name: Run `packer build`
        id: build
        run: packer build ./images/ubuntu/templates/${{ inputs.hcl_filename }}
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
          HCLOUD_SNAPSHOT_NAME: ${{ steps.hcloudvmname.outputs.value }}
          

      - name: Commit & Push changes
        uses: actions-js/push@5a7cbd780d82c0c937b5977586e641b2fd94acc5 # v1.5
        with:
          branch: ${{ inputs.release_tag }}
          github_token: ${{ secrets.GH_TOKEN }}
          force: true


  CreatePullRequest:
    needs:
      - CreateVmTemplate
    runs-on: ubuntu-latest

    permissions:
#      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout new created branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: '0'
          ref: ${{ inputs.release_tag }}

      - name: Read ubuntu2404-Readme.md
        id: ubuntu2404readme
        uses: jaywcjlove/github-action-read-file@546dbc91f1187996f2ef0f5a199a9a4af05a978b # v2.0.0
        with:
          branch: ${{ inputs.release_tag }}
          path: images/ubuntu/Ubuntu2404-Readme.md

      - name: Run the Action
        uses: devops-infra/action-pull-request@ff118b4a7c24bac5a3c95acef59e9edd1fc37890 # v0.6.0
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          source_branch: ${{ inputs.release_tag }}
          target_branch: master
          title: ${{ inputs.release_name }}
          body: ${{ steps.ubuntu2404readme.outputs.content }}


      - name: Create a new release
        uses: ncipollo/release-action@440c8c1cb0ed28b9f43e4d1d670870f059653174 # v1.16.0
        with:
          tag: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name }}
          body: ${{ steps.ubuntu2404readme.outputs.content }}
          token: ${{ secrets.GH_TOKEN }}          
