name: Test tag exist
on:
  workflow_dispatch:
    inputs:
      os:
        type: choice
        description: Ubuntu Server OS
        options:
          - ubuntu24
          - ubuntu22
        required: false
jobs:
#  BasicInformations:
#    runs-on: ubuntu-latest
#      
#    steps:
#      - name: Get current date
#        id: date
#        run: echo "::set-output name=date::$(date +'%Y%m%d')"
        
#    outputs:
      #ReleaseName: Ubuntu 24.04 (${{ steps.date.outputs.date }}) Image Update
      #ReleaseTag: ubuntu24/${{ steps.date.outputs.date }}.1
      #ReleaseDate: ${{ steps.date.outputs.date }}
#      ReleaseName: "Ubuntu 24.04 (20250311.1) Image Update"
#      ReleaseTag: "ubuntu24/20250311.1"
#      ReleaseDate: "20250311"

  BasicInformations:
#    needs: BasicInformations
    runs-on: ubuntu-latest
      
    steps:
#      - name: Send greeting
#        run: echo "${{ github.event.inputs.os }}"
      - name: condition 1
        id: test1
        #if: ${{ github.event.inputs.os }} == 'ubuntu22'
        #run: echo "Ubuntu 22.04" >> $GITHUB_OUTPUT
        #env: 
        #  os: ${{ github.event.inputs.os }}
        run: |
          if [ "${{ github.event.inputs.os }}" == "ubuntu22" ]; then
            echo "osname=Ubuntu 22.04" >> $GITHUB_OUTPUT
          else
            echo "osname=Ubuntu 24.04" >> $GITHUB_OUTPUT
          fi
          
      - name: condition 1 Check
        run: |
          echo 'Output from Find Tag: ${{steps.test1.outputs.osname}}'
      
      - name: Checkout
        uses: actions/checkout@v2
    
      - name: Find Tag
        id: tagger
        uses: digital-ai/query-tag-action@v2
        with:
          include: ubuntu24/20250312.*
          #exclude: '*-rc*'
          #commit-ish: 'HEAD'
          exact-match: 'false'
          no-tags-text: 'false'
          # if you unshallow in a separate step, use the following option:
          # skip-unshallow: 'true'
      - name: Show Tag 1
        if: steps.tagger.outputs.tag == 'false'
        #if: ${{ (steps.tagger.outputs.tag != 'NO_TAGS') }}
        id: display1
        run: |
          echo 'Output from Find Tag: ${{steps.tagger.outputs.tag}}'

#      - name: Show Tag 2
#        if: steps.tagger.outputs.tag != 'false'
#        #if: ${{ (steps.tagger.outputs.tag != 'NO_TAGS') }}
#        id: display2
#        run: |
#          echo 'Output from Find Tag: ${{steps.tagger.outputs.tag}}'

      - name: Create a new release name
        #if: steps.tagger.outputs.tag != 'false'
        id: date
        #run: echo "::set-output name=date::$(date +'%Y%m%d').1"
        #run: echo "date=$(date +'%Y%m%d').1" >> $GITHUB_OUTPUT
        run: |
          if [ "${{ steps.tagger.outputs.tag }}" == "'false'" ]; then
            echo "date=$(date +'%Y%m%d').1" >> $GITHUB_OUTPUT
          else
            #mails=$(echo steps.tagger.outputs.tag | tr ".")
            ver=$("${{ steps.tagger.outputs.tag }}" | cut -d '.' -f 2)
            #ver=$ver+1
            ver=`expr $ver + 1`
            echo "date=$(date +'%Y%m%d').$ver" >> $GITHUB_OUTPUT
          fi
              
    outputs:
      ReleaseName: Ubuntu 24.04 (${{ steps.date.outputs.date }}) Image Update
      ReleaseTag: ${{ github.event.inputs.os }}/${{ steps.date.outputs.date }}
      ReleaseDate: ${{ steps.date.outputs.date }}



  CreateTest:
    needs: BasicInformations
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Write ReleaseName
        run: echo "${{ needs.BasicInformations.outputs.ReleaseName }}"

      - name: Write ReleaseTag
        run: echo "${{ needs.BasicInformations.outputs.ReleaseTag }}"
    
#      - uses: mukunku/tag-exists-action@v1.6.0
#        id: check-tag
#        with: 
#          #tag: ${{ needs.BasicInformations.outputs.ReleaseTag }}
#          tag: ubuntu24/20250311.*
#          repo: 'dwydler/test1'

#      - name: Split branch name
#        env:
#          BRANCH: ${{ needs.BasicInformations.outputs.ReleaseTag }}
#        id: split
#        run: echo "fragment=${BRANCH##*/}" >> $GITHUB_OUTPUT
#
#      - name: Test variable
#        run: |
#          echo ${{ steps.split.outputs.fragment }}
#        
#      - name: determine docker tag by splitting branch name on slash
#        if: steps.check-tag.outputs.exists == 'true'
#        id: docker-tag
#        shell: bash
#        run: |
#          split=(${needs.BasicInformations.outputs.ReleaseTag//\// })
#          index=$((${#split[@]}-1))
#          DOCKER_TAG=${split[$index]}
#          echo DOCKER_TAG=$DOCKER_TAG >> $GITHUB_ENV
#          echo "::set-output name=DOCKER_TAG::$DOCKER_TAG"
